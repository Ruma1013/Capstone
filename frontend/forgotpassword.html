<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password</title>
    <link rel="stylesheet" href="css/forgotpassword.css">
</head>

<body>
    <div class="container">
        <form>
            <h2>Forgot Password</h2>
            <div class="input-field">
                <input type="text" id="licenseNumber" required>
                <label for="licenseNumber">Enter your License number</label>
            </div>
            <div class="input-field" id="phoneNumberField" style="display: none;">
                <input type="tel" id="phoneNumber">
                <label>Enter your Phone number</label>
            </div>
            <div class="input-field" id="otpField" style="display: none;">
                <input type="text" id="otp" required>
                <label>Enter OTP</label>
            </div>
            <button type="button" id="submitLicenseNumber">Submit</button>
            <button type="button" id="submitOTP" style="display: none;">Submit OTP</button>
            <button type="button" id="submitNewPassword" style="display: none;">Submit New Password</button>
        </form>
    </div>

    <script>
        document.getElementById("submitLicenseNumber").addEventListener("click", function () {
            var licenseNumber = document.getElementById("licenseNumber").value;
            var phoneNumberField = document.getElementById("phoneNumberField");
            if (licenseNumber.trim() === "") {
                alert("Please enter your License number.");
                return;
            }
            // Send licenseNumber to backend to check existence and get phone number
            fetch('/api/forgot-password-check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ licenseNumber }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.phoneNumber) {
                        phoneNumberField.style.display = "block";
                        document.getElementById("submitOTP").style.display = "block";
                        document.getElementById("submitLicenseNumber").style.display = "none";
                        // Change the text of the button to "Submit OTP"
                        document.getElementById("submitLicenseNumber").textContent = "Submit OTP";
                    } else {
                        // If phone number not provided, skip OTP verification
                        document.getElementById("submitLicenseNumber").style.display = "none";
                        document.getElementById("submitNewPassword").style.display = "block";
                    }
                } else {
                    alert(data.message || "License number not found.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred. Please try again later.");
            });
        });
    
        document.getElementById("submitOTP").addEventListener("click", function () {
            var licenseNumber = document.getElementById("licenseNumber").value;
            var otp = document.getElementById("otp").value;
            if (otp.trim() === "") {
                alert("Please enter the OTP.");
                return;
            }
            // Send licenseNumber and OTP to backend to verify
            fetch('/api/verify-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ licenseNumber, otp }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("otpField").style.display = "none";
                    document.getElementById("submitOTP").style.display = "none";
                    document.getElementById("submitNewPassword").style.display = "block";
                } else {
                    alert(data.message || "Invalid OTP. Please try again.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred. Please try again later.");
            });
        });
    
        document.getElementById("submitNewPassword").addEventListener("click", function () {
            var newPassword = document.getElementById("newPassword").value;
            if (newPassword.trim() === "") {
                alert("Please enter your new password.");
                return;
            }
            // Send newPassword to backend to update password
            fetch('/api/update-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ newPassword }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Password updated successfully. You can now log in with your new password.");
                    window.location.href = "login.html"; // Redirect to login page
                } else {
                    alert(data.message || "Password update failed. Please try again.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred. Please try again later.");
            });
        });
    </script>
    
</body>

</html>
